# Library Documentation

Core library functions and utilities for Club 19 Sales OS.

## Database Operations

### `xata-sales.ts`
Central database operations for sales records.

**Key functions:**
- `createSaleRecord()` - Create new sale with full validation
- `getSaleById()` - Fetch single sale with relations
- `updateSaleStatus()` - Update invoice and payment status
- `calculateCommission()` - Compute shopper commission based on margin

### `xata.ts` (src/)
Xata database client and schema types. Auto-generated by `@xata.io/cli`.

## Authentication & Authorization

### `getUserRole.ts`
Resolve staff role from Clerk user metadata.

```typescript
const role = await getUserRole();
// Returns: 'superadmin' | 'founder' | 'operations' | 'admin' | 'finance' | 'shopper' | null
```

### `getCurrentUser.ts`
Get current authenticated user details.

```typescript
const user = await getCurrentUser();
// Returns: { id, email, fullName, role }
```

**Note:** Server-only component (uses `server-only` package).

### `permissions.ts`
RBAC single source of truth. Defines all role capabilities.

**Exports:**
- `ROLE_HIERARCHY` - Role levels and inheritance
- `PERMISSIONS` - Feature flags per role
- `hasPermission(role, permission)` - Check access

## Xero Integration

### `xero-auth.ts`
OAuth 2.0 flow for Xero API access.

**Functions:**
- `getAuthUrl()` - Generate OAuth authorize URL
- `exchangeCodeForTokens()` - Exchange auth code for tokens
- `getValidTokens()` - Get tokens, auto-refresh if expired
- `storeTokens()` - Save tokens to Clerk privateMetadata

### `xero.ts`
Xero API client and operations.

**Functions:**
- `createInvoice()` - Create invoice in Xero
- `getInvoiceStatus()` - Fetch invoice details
- `syncInvoiceStatus()` - Update local records from Xero
- `verifyWebhookSignature()` - Validate Xero webhook requests

## Business Logic

### `economics.ts`
Commission and VAT calculations.

**Exports:**
- `calculateCommission(margin, rate)` - Compute shopper commission
- `calculateVAT(amount, rate)` - UK VAT logic
- `calculateGrossMargin(salePrice, buyPrice, costs)` - Margin calculation

### `validation.ts`
Input validation and sanitization.

**Functions:**
- `validateTradeData()` - Validate deal creation input
- `validateSupplierData()` - Validate supplier info
- `sanitizeInput()` - XSS protection

### `dateUtils.ts`
Date formatting and range calculations.

**Functions:**
- `getMonthDateRange(monthParam)` - Parse month filter (e.g., "2025-01")
- `formatMonthLabel(monthParam)` - Format as "January 2025"
- `isDateValid(date)` - Check date validity

## Utilities

### `logger.ts`
Structured logging utility.

```typescript
import * as logger from '@/lib/logger';

logger.info('CATEGORY', 'Message', { metadata });
logger.error('CATEGORY', 'Error occurred', { error });
logger.warn('CATEGORY', 'Warning', { data });
```

All logs include timestamp and category for debugging.

### `cn.ts`
Tailwind CSS class merging utility (uses `clsx` and `tailwind-merge`).

```typescript
import { cn } from '@/lib/cn';

className={cn('base-class', condition && 'conditional-class')}
```

### `legacyData.ts`
Legacy system data queries and transformations.

**Exports:**
- `getLegacySummary()` - Aggregate legacy sales stats
- `getLegacyTrades()` - Fetch historical trades
- Interfaces for legacy data types

## Type Definitions

### `roleTypes.ts`
TypeScript types for roles and staff members.

```typescript
export type StaffRole =
  | 'superadmin'
  | 'founder'
  | 'operations'
  | 'admin'
  | 'finance'
  | 'shopper';
```

### `types/`
Additional type definitions for API responses, forms, etc.

## Best Practices

1. **Server-only Functions**: Use `server-only` package for database operations
2. **Error Handling**: Always wrap database calls in try-catch
3. **Logging**: Use structured logging for all operations
4. **Type Safety**: Import types from `@/src/xata` for database records
5. **Validation**: Validate all user input before database writes
6. **Transactions**: Use Xata transactions for multi-step operations

## Common Patterns

### Database Query
```typescript
import { getXataClient } from '@/src/xata';

const xata = getXataClient();
const sales = await xata.db.Sales
  .filter({ shopper: shopperId })
  .select(['id', 'sale_date', 'sale_amount_inc_vat'])
  .getMany();
```

### Role Check
```typescript
import { getUserRole } from '@/lib/getUserRole';
import { hasPermission } from '@/lib/permissions';

const role = await getUserRole();
if (!hasPermission(role, 'manage_sales')) {
  return <AccessDenied />;
}
```

### Xero API Call
```typescript
import { getValidTokens } from '@/lib/xero-auth';

const tokens = await getValidTokens(userId);
const response = await fetch('https://api.xero.com/api.xro/2.0/Invoices', {
  headers: {
    'Authorization': `Bearer ${tokens.accessToken}`,
    'Xero-Tenant-Id': tokens.tenantId,
  },
});
```

---

For more details, see the main [README.md](../README.md) and inline JSDoc comments in each file.
